name: Build macOS (Latest) and Release

on:
  push:
    branches:
      - main
    paths:
      - '**/*.json'
      - '**/*.py'
      - '**/*.yml'

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install create-dmg
      run: |
        npm install -g create-dmg

    - name: Generate CFBundleVersion with current date
      id: generate_version
      run: |
        echo "::set-output name=date::$(date +'%Y%m%d')"

    - name: Modify Info.plist with version and date
      run: |
        INFO_PLIST="path/to/Info.plist"  # Replace with the actual path to your Info.plist file
        DATE=$(echo "${{ steps.generate_version.outputs.date }}")
        plutil -replace CFBundleVersion -string "${DATE}" "${INFO_PLIST}"

    - name: Build macOS app
      run: |
        pyinstaller --name 'MyAmpSwitcher' \
                    --icon 'icon.icns' \
                    --noconsole  \
                    --windowed  \
                    --add-data './settings.json:.' \
                    --add-data './icon.icns:.' \
                    --add-data './profiles/*:profiles' \
                    --additional-hooks-dir='./' \
                    --hidden-import mido.backends.rtmidi \
                    --hidden-import pyqt5 \
                    --codesign-identity "Paolo Frigo" \
                    --version-file "path/to/Info.plist" \
                    MyAmpSwitcher.py

        mkdir -p dist/dmg
        cp -r "dist/MyAmpSwitcher.app" dist/dmg

        create-dmg \
          --volname "MyAmpSwitcher" \
          --volicon "icon.ico" \
          --window-pos 200 120 \
          --window-size 600 300 \
          --icon-size 100 \
          --icon "MyAmpSwitcher.app" 175 120 \
          --hide-extension "MyAmpSwitcher.app" \
          --app-drop-link 425 120 \
          "dist/MyAmpSwitcher.dmg" \
          "dist/dmg/"
          
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v2
      with:
        name: MyAmpSwitcher_macOS_latest
        path: dist

  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v2
        with:
          name: MyAmpSwitcher_macOS_latest

      - name: Remove old macOS artifacts
        run: |
          if [ -f dist/MyAmpSwitcher_macOS_latest.zip ]; then
            ls -1 | grep '_macOS_latest.zip$' | sort -r | tail -n +3 | xargs rm -rf
          fi
